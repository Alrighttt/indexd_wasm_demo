<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>indexd WASM Demo</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; background: #0a0a0a; color: #e0e0e0; padding: 2rem; max-width: 800px; margin: 0 auto; }
    h1 { font-size: 1.5rem; margin-bottom: 1.5rem; color: #fff; }
    h2 { font-size: 1.1rem; margin-bottom: 0.75rem; color: #b0b0b0; }
    section { background: #151515; border: 1px solid #2a2a2a; border-radius: 8px; padding: 1.25rem; margin-bottom: 1.25rem; }
    button { background: #1a6b3c; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem; }
    button:hover { background: #1f8148; }
    button:disabled { background: #333; color: #666; cursor: not-allowed; }
    input, textarea { background: #1a1a1a; color: #e0e0e0; border: 1px solid #333; border-radius: 4px; padding: 0.5rem; width: 100%; font-family: monospace; font-size: 0.8rem; }
    textarea { resize: vertical; min-height: 3rem; }
    .row { display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem; }
    .output { background: #0d0d0d; border: 1px solid #222; border-radius: 4px; padding: 0.75rem; margin-top: 0.75rem; font-family: monospace; font-size: 0.8rem; white-space: pre-wrap; word-break: break-all; min-height: 2rem; }
    .label { font-size: 0.75rem; color: #888; margin-bottom: 0.25rem; }
    .pass { color: #4ade80; }
    .fail { color: #f87171; }
    #loading { text-align: center; padding: 2rem; color: #888; }
    #app { display: none; }
    .dropzone { border: 2px dashed #333; border-radius: 8px; padding: 2rem; text-align: center; color: #666; cursor: pointer; transition: border-color 0.2s, color 0.2s; }
    .dropzone:hover, .dropzone.dragover { border-color: #1a6b3c; color: #4ade80; }
    .dropzone .file-info { color: #e0e0e0; font-size: 0.85rem; margin-top: 0.5rem; }
    hr { border: none; border-top: 1px solid #2a2a2a; margin: 1rem 0; }
    progress { width: 100%; height: 8px; appearance: none; border: none; border-radius: 4px; overflow: hidden; margin-top: 0.5rem; }
    progress::-webkit-progress-bar { background: #1a1a1a; border-radius: 4px; }
    progress::-webkit-progress-value { background: #1a6b3c; border-radius: 4px; }
    progress::-moz-progress-bar { background: #1a6b3c; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>indexd WASM Demo</h1>

  <div id="loading">Loading WASM module...</div>

  <div id="app">
    <!-- Configuration -->
    <section>
      <h2>Configuration</h2>
      <div class="label">Indexer URL</div>
      <input id="cfg-url" type="text" placeholder="https://indexer.example.com" style="margin-bottom:0.5rem" />
      <div class="label">App Key (hex seed)</div>
      <input id="cfg-key" type="text" placeholder="e.g. ab12cd34..." style="margin-bottom:0.5rem" />
      <hr />
      <div class="label">Recovery Phrase</div>
      <div class="row">
        <input id="phrase" type="text" placeholder="recovery phrase appears here" />
        <button id="btn-generate">Generate</button>
        <button id="btn-validate">Validate</button>
      </div>
      <div class="output" id="phrase-output"></div>
    </section>

    <!-- Register -->
    <section>
      <h2>Register App</h2>
      <div class="label">App Name</div>
      <input id="reg-name" type="text" placeholder="My App" style="margin-bottom:0.5rem" />
      <div class="label">App Description</div>
      <input id="reg-desc" type="text" placeholder="A brief description of your app" style="margin-bottom:0.5rem" />
      <div class="label">Service URL</div>
      <input id="reg-service-url" type="text" placeholder="https://myapp.example.com" style="margin-bottom:0.5rem" />
      <div class="row">
        <button id="btn-gen-curl">1. Generate curl command</button>
      </div>
      <div class="output" id="reg-curl" style="display:none; cursor:pointer;" title="Click to copy"></div>
      <div id="reg-paste-section" style="display:none; margin-top:0.75rem;">
        <div class="label">Paste the JSON response from curl here:</div>
        <textarea id="reg-response" rows="3" placeholder='{"responseURL":"...","statusURL":"...","registerURL":"...","expiration":"..."}'></textarea>
        <div class="row" style="margin-top:0.5rem">
          <button id="btn-set-response">2. Continue</button>
        </div>
      </div>
      <div class="output" id="reg-status" style="display:none;"></div>
      <div id="reg-approval" style="display:none; margin-top:0.75rem;">
        <div class="label">Approve the connection by visiting the link above, then:</div>
        <div class="row">
          <button id="btn-wait-approval">3. Wait for Approval</button>
        </div>
      </div>
      <div id="reg-finalize" style="display:none; margin-top:0.75rem;">
        <div class="label">Recovery Phrase (uses the phrase from Configuration above, or enter one here)</div>
        <div class="row">
          <input id="reg-mnemonic" type="text" placeholder="leave blank to use the phrase above" />
          <button id="btn-reg-generate">Generate</button>
        </div>
        <div class="row" style="margin-top:0.5rem">
          <button id="btn-register">4. Register</button>
        </div>
      </div>
      <div class="output" id="reg-result" style="display:none; margin-top:0.75rem;"></div>
    </section>

    <!-- Upload Text -->
    <section>
      <h2>Upload Text</h2>
      <div class="label">Text to upload</div>
      <textarea id="ul-text" rows="4" placeholder="Type or paste text here..."></textarea>
      <div class="row" style="margin-top:0.5rem">
        <button id="btn-upload">Upload</button>
      </div>
      <progress id="ul-progress" max="100" value="0" style="display:none"></progress>
      <div class="output" id="ul-status"></div>
    </section>

    <!-- Download Text -->
    <section>
      <h2>Download Text</h2>
      <div class="label">Object ID (hex)</div>
      <div class="row">
        <input id="dt-object-id" type="text" placeholder="e.g. 0e90d697f504..." />
        <button id="btn-download-text">Download</button>
      </div>
      <progress id="dt-progress" max="100" value="0" style="display:none"></progress>
      <div class="output" id="dt-status"></div>
      <div class="label" style="margin-top:0.75rem">Contents</div>
      <div class="output" id="dt-contents" style="min-height:6rem; max-height:24rem; overflow-y:auto;"></div>
    </section>

    <!-- Upload File -->
    <section>
      <h2>Upload File</h2>
      <div class="dropzone" id="uf-dropzone">
        Drop a file here or click to select
        <input type="file" id="uf-file" style="display:none" />
        <div class="file-info" id="uf-file-info"></div>
      </div>
      <div class="row" style="margin-top:0.5rem">
        <button id="btn-upload-file">Upload</button>
      </div>
      <progress id="uf-progress" max="100" value="0" style="display:none"></progress>
      <div class="output" id="uf-status"></div>
    </section>

    <!-- Download File -->
    <section>
      <h2>Download File</h2>
      <div class="label">Object ID (hex)</div>
      <input id="dl-object-id" type="text" placeholder="e.g. 0e90d697f504..." style="margin-bottom:0.5rem" />
      <div class="label">Filename</div>
      <div class="row">
        <input id="dl-filename" type="text" placeholder="e.g. photo.jpg" />
        <button id="btn-download">Download</button>
      </div>
      <progress id="dl-progress" max="100" value="0" style="display:none"></progress>
      <div class="output" id="dl-status"></div>
    </section>

    <!-- Share Object -->
    <section>
      <h2>Share Object</h2>
      <div class="label">Object ID (hex)</div>
      <input id="share-object-id" type="text" placeholder="e.g. 0e90d697f504..." style="margin-bottom:0.5rem" />
      <div class="label">Expires in</div>
      <div class="row">
        <input id="share-duration" type="number" value="24" min="1" style="width:5rem" />
        <select id="share-unit" style="background:#1a1a1a; color:#e0e0e0; border:1px solid #333; border-radius:4px; padding:0.5rem;">
          <option value="3600000">hours</option>
          <option value="86400000" selected>days</option>
          <option value="604800000">weeks</option>
        </select>
        <button id="btn-share">Generate Link</button>
      </div>
      <div class="output" id="share-status"></div>
      <hr />
      <div class="label">Download from Share URL</div>
      <input id="share-url" type="text" placeholder="Paste share URL here..." style="margin-bottom:0.5rem" />
      <div class="label">Filename</div>
      <div class="row">
        <input id="share-filename" type="text" placeholder="e.g. photo.jpg" />
        <button id="btn-share-download">Download</button>
      </div>
      <progress id="share-progress" max="100" value="0" style="display:none"></progress>
      <div class="output" id="share-dl-status"></div>
    </section>

    <!-- Stream HTML Page -->
    <section>
      <h2>Stream HTML Page</h2>
      <div class="label">Object ID</div>
      <input id="stream-object-id" type="text" placeholder="hex object id" />
      <div class="label" style="margin-top:0.75rem">OR Share URL</div>
      <input id="stream-share-url" type="text" placeholder="sia:// or https:// share URL" />
      <div class="row" style="margin-top:0.5rem">
        <button id="btn-stream-html">Stream to iFrame</button>
      </div>
      <progress id="stream-progress" max="100" value="0" style="display:none"></progress>
      <div class="output" id="stream-status"></div>
      <iframe id="stream-iframe" sandbox="allow-same-origin" style="display:none; width:100%; height:400px; border:1px solid #333; border-radius:4px; margin-top:1rem;"></iframe>
    </section>

    <!-- Sign / Verify -->
    <section>
      <h2>Sign &amp; Verify</h2>
      <div class="label">Message</div>
      <input id="sign-message" type="text" placeholder="message to sign" />
      <div class="row" style="margin-top:0.5rem">
        <button id="btn-sign">Sign</button>
        <button id="btn-verify">Verify</button>
      </div>
      <div class="output" id="sign-output"></div>
    </section>
  </div>

  <script type="module">
    import init, {
      generateRecoveryPhrase,
      validateRecoveryPhrase,
      AppKey,
      Builder,
    } from './pkg/indexd_wasm.js';

    let currentKey = null;
    let lastSignature = null;

    function hex(bytes) {
      return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function randomHex(len) {
      const arr = new Uint8Array(len);
      crypto.getRandomValues(arr);
      return hex(arr);
    }

    function fromHex(h) {
      const bytes = new Uint8Array(h.length / 2);
      for (let i = 0; i < bytes.length; i++) {
        bytes[i] = parseInt(h.substr(i * 2, 2), 16);
      }
      return bytes;
    }

    function formatSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' GB';
    }

    // helpers to read shared config
    function getUrl() { return document.getElementById('cfg-url').value.trim(); }
    function getKeyHex() { return document.getElementById('cfg-key').value.trim(); }

    async function connectSdk(statusEl) {
      const url = getUrl();
      const keyHex = getKeyHex();
      if (!url || !keyHex) {
        statusEl.innerHTML = '<span class="fail">Set Indexer URL and App Key in Configuration first</span>';
        return null;
      }
      statusEl.textContent = 'Creating app key...';
      const seed = fromHex(keyHex);
      const appKey = new AppKey(seed);
      statusEl.textContent = `App key created. Public key: ${appKey.publicKey()}\nConnecting to indexer...`;
      const builder = new Builder(url);
      const sdk = await builder.connected(appKey);
      if (!sdk) {
        statusEl.innerHTML = '<span class="fail">App key not recognized by this indexer. Register first.</span>';
        return null;
      }
      statusEl.innerHTML = '<span class="pass">Connected!</span>';
      return sdk;
    }

    await init();
    document.getElementById('loading').style.display = 'none';
    document.getElementById('app').style.display = 'block';

    // -- Recovery Phrase --
    document.getElementById('btn-generate').addEventListener('click', () => {
      const phrase = generateRecoveryPhrase();
      document.getElementById('phrase').value = phrase;
      document.getElementById('phrase-output').innerHTML = '<span class="pass">Generated successfully</span>';
    });

    document.getElementById('btn-validate').addEventListener('click', () => {
      const phrase = document.getElementById('phrase').value.trim();
      const out = document.getElementById('phrase-output');
      if (!phrase) {
        out.innerHTML = '<span class="fail">Enter a phrase first</span>';
        return;
      }
      try {
        validateRecoveryPhrase(phrase);
        out.innerHTML = '<span class="pass">Valid recovery phrase</span>';
      } catch (e) {
        out.innerHTML = `<span class="fail">Invalid: ${e.message}</span>`;
      }
    });

    // -- Register --
    let regBuilder = null;
    let regAppId = null;

    document.getElementById('btn-gen-curl').addEventListener('click', () => {
      const curlDiv = document.getElementById('reg-curl');
      const pasteSection = document.getElementById('reg-paste-section');
      const status = document.getElementById('reg-status');
      const approvalDiv = document.getElementById('reg-approval');
      const finalizeDiv = document.getElementById('reg-finalize');
      const resultDiv = document.getElementById('reg-result');
      const url = getUrl();
      const name = document.getElementById('reg-name').value.trim();
      const desc = document.getElementById('reg-desc').value.trim();
      const serviceUrl = document.getElementById('reg-service-url').value.trim();

      status.style.display = 'none';
      approvalDiv.style.display = 'none';
      finalizeDiv.style.display = 'none';
      resultDiv.style.display = 'none';

      if (!url || !name || !desc || !serviceUrl) {
        curlDiv.style.display = 'block';
        curlDiv.innerHTML = '<span class="fail">Indexer URL (in Configuration) and all fields are required</span>';
        return;
      }

      regAppId = randomHex(32);
      const body = JSON.stringify({
        appID: regAppId,
        name: name,
        description: desc,
        serviceURL: serviceUrl,
      });

      const curlCmd = `curl -s -X POST ${url}/auth/connect -H 'Content-Type: application/json' -d '${body}'`;
      curlDiv.style.display = 'block';
      curlDiv.textContent = curlCmd;
      pasteSection.style.display = 'block';

      curlDiv.onclick = () => {
        navigator.clipboard.writeText(curlCmd);
        curlDiv.innerHTML = curlDiv.textContent + '\n<span class="pass">Copied!</span>';
      };
    });

    document.getElementById('btn-set-response').addEventListener('click', () => {
      const status = document.getElementById('reg-status');
      const approvalDiv = document.getElementById('reg-approval');
      const responseJson = document.getElementById('reg-response').value.trim();
      const url = getUrl();

      if (!responseJson) {
        status.style.display = 'block';
        status.innerHTML = '<span class="fail">Paste the JSON response first</span>';
        return;
      }

      try {
        const parsed = JSON.parse(responseJson);
        if (!parsed.responseURL || !parsed.statusURL || !parsed.registerURL) {
          throw new Error('Response must contain responseURL, statusURL, and registerURL');
        }

        regBuilder = new Builder(url);
        regBuilder.setConnectionResponse(regAppId, responseJson);

        const responseUrl = regBuilder.responseUrl();
        status.style.display = 'block';
        status.innerHTML = `<span class="pass">Connection response accepted!</span>\n\nApprove this app by visiting:\n<a href="${responseUrl}" target="_blank" rel="noopener" style="color:#60a5fa; word-break:break-all;">${responseUrl}</a>`;
        approvalDiv.style.display = 'block';
      } catch (e) {
        status.style.display = 'block';
        status.innerHTML = `<span class="fail">Error: ${e.message}</span>`;
      }
    });

    document.getElementById('btn-wait-approval').addEventListener('click', async () => {
      const status = document.getElementById('reg-status');
      const finalizeDiv = document.getElementById('reg-finalize');
      const btn = document.getElementById('btn-wait-approval');

      if (!regBuilder) {
        status.innerHTML += `\n<span class="fail">Complete steps 1 and 2 first</span>`;
        return;
      }

      try {
        btn.disabled = true;
        btn.textContent = 'Waiting for approval...';
        status.innerHTML += '\n\nPolling for approval (this may take a while)...';

        await regBuilder.waitForApproval();

        status.innerHTML += `\n<span class="pass">Approved!</span>`;
        btn.textContent = 'Approved!';
        finalizeDiv.style.display = 'block';
      } catch (e) {
        btn.disabled = false;
        btn.textContent = '3. Wait for Approval';
        status.innerHTML += `\n<span class="fail">Error: ${e.message}</span>`;
      }
    });

    document.getElementById('btn-reg-generate').addEventListener('click', () => {
      document.getElementById('reg-mnemonic').value = generateRecoveryPhrase();
    });

    document.getElementById('btn-register').addEventListener('click', async () => {
      const status = document.getElementById('reg-status');
      const resultDiv = document.getElementById('reg-result');
      // use register-specific mnemonic if provided, otherwise fall back to config phrase
      const mnemonic = document.getElementById('reg-mnemonic').value.trim()
        || document.getElementById('phrase').value.trim();

      if (!regBuilder) {
        status.innerHTML += `\n<span class="fail">Complete previous steps first</span>`;
        return;
      }
      if (!mnemonic) {
        status.innerHTML += `\n<span class="fail">Enter a recovery phrase in Configuration or the field above</span>`;
        return;
      }

      try {
        status.innerHTML += '\nRegistering...';
        const sdk = await regBuilder.register(mnemonic);
        const appKey = sdk.appKey();
        const seed = hex(appKey.export());
        const pubkey = appKey.publicKey();

        // auto-fill the config app key field
        document.getElementById('cfg-key').value = seed;

        status.innerHTML += `\n<span class="pass">Registered successfully!</span>`;
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `<span class="pass">Registration complete!</span>\n\nApp Key Seed (auto-filled in Configuration above):\n${seed}\n\nPublic Key:\n${pubkey}\n\n<span style="color:#fbbf24;">Save your recovery phrase and app key seed securely!</span>`;
        regBuilder = null;
      } catch (e) {
        status.innerHTML += `\n<span class="fail">Error: ${e.message}</span>`;
      }
    });

    // -- Upload Text --
    document.getElementById('btn-upload').addEventListener('click', async () => {
      const status = document.getElementById('ul-status');
      const progress = document.getElementById('ul-progress');
      const text = document.getElementById('ul-text').value;

      if (!text) {
        status.innerHTML = '<span class="fail">Enter some text to upload</span>';
        return;
      }

      progress.style.display = 'none';
      progress.value = 0;

      try {
        const sdk = await connectSdk(status);
        if (!sdk) return;

        const data = new TextEncoder().encode(text);
        progress.style.display = 'block';
        status.textContent = 'Uploading...';

        const uploadStart = performance.now();
        const obj = await sdk.uploadWithProgress(data, (current, total) => {
          progress.max = total;
          progress.value = current;
          status.textContent = `Uploading... ${current}/${total} shards`;
        });
        const elapsed = ((performance.now() - uploadStart) / 1000).toFixed(1);
        const objectId = obj.id();
        const size = obj.size();

        progress.value = progress.max;
        status.innerHTML = `Upload complete (${size} bytes) in ${elapsed}s. Pinning to indexer...`;

        await sdk.pinObject(obj);

        status.innerHTML += `\n<span class="pass">Pinned!</span>\n\nObject ID: ${objectId}`;
      } catch (e) {
        status.innerHTML += `\n<span class="fail">Error: ${e.message}</span>`;
      }
    });

    // -- Download Text --
    document.getElementById('btn-download-text').addEventListener('click', async () => {
      const status = document.getElementById('dt-status');
      const progress = document.getElementById('dt-progress');
      const contents = document.getElementById('dt-contents');
      const objectId = document.getElementById('dt-object-id').value.trim();

      contents.textContent = '';
      progress.style.display = 'none';
      progress.value = 0;

      if (!objectId) {
        status.innerHTML = '<span class="fail">Enter an Object ID</span>';
        return;
      }

      try {
        const sdk = await connectSdk(status);
        if (!sdk) return;

        status.innerHTML += '\nFetching object metadata...';

        const obj = await sdk.object(objectId);
        const size = obj.size();
        status.innerHTML = `Object found: ${formatSize(size)}`;

        progress.style.display = 'block';
        status.textContent = 'Downloading...';

        const downloadStart = performance.now();
        const data = await sdk.downloadWithProgress(obj, (current, total) => {
          progress.max = total;
          progress.value = current;
          status.textContent = `Downloading... ${current}/${total} slabs`;
        });
        const elapsed = ((performance.now() - downloadStart) / 1000).toFixed(1);
        const text = new TextDecoder('utf-8', { fatal: false }).decode(data);

        progress.value = progress.max;
        status.innerHTML = `Size: ${formatSize(size)}\nDownloaded in ${elapsed}s\n<span class="pass">Download complete!</span>`;
        contents.textContent = text;
      } catch (e) {
        status.innerHTML += `\n<span class="fail">Error: ${e.message}</span>`;
      }
    });

    // -- Upload File --
    let selectedFile = null;
    const dropzone = document.getElementById('uf-dropzone');
    const fileInput = document.getElementById('uf-file');
    const fileInfo = document.getElementById('uf-file-info');

    function setFile(file) {
      selectedFile = file;
      fileInfo.textContent = `${file.name} (${formatSize(file.size)})`;
    }

    dropzone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', () => {
      if (fileInput.files.length) setFile(fileInput.files[0]);
    });
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });
    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragover');
    });
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      if (e.dataTransfer.files.length) setFile(e.dataTransfer.files[0]);
    });

    document.getElementById('btn-upload-file').addEventListener('click', async () => {
      const status = document.getElementById('uf-status');
      const progress = document.getElementById('uf-progress');
      const MAX_FILE_SIZE = 2 * 1024 * 1024 * 1024; // 2 GB - wasm32 memory limit

      if (!selectedFile) {
        status.innerHTML = '<span class="fail">Select a file first</span>';
        return;
      }

      if (selectedFile.size > MAX_FILE_SIZE) {
        status.innerHTML = `<span class="fail">File too large (${formatSize(selectedFile.size)}). Maximum is 2 GB due to WASM memory limits.</span>`;
        return;
      }

      progress.style.display = 'none';
      progress.value = 0;

      try {
        const sdk = await connectSdk(status);
        if (!sdk) return;

        status.innerHTML += '\nReading file...';

        const buffer = await selectedFile.arrayBuffer();
        const data = new Uint8Array(buffer);

        progress.style.display = 'block';
        status.textContent = `Uploading ${selectedFile.name} (${formatSize(data.length)})...`;

        const uploadStart = performance.now();
        const obj = await sdk.uploadWithProgress(data, (current, total) => {
          progress.max = total;
          progress.value = current;
          status.textContent = `Uploading ${selectedFile.name}... ${current}/${total} shards`;
        });
        const elapsed = ((performance.now() - uploadStart) / 1000).toFixed(1);
        const objectId = obj.id();
        const size = obj.size();

        progress.value = progress.max;
        status.innerHTML = `Upload complete (${formatSize(size)}) in ${elapsed}s. Pinning to indexer...`;

        await sdk.pinObject(obj);

        status.innerHTML = `File: ${selectedFile.name}\nSize: ${formatSize(size)}\nUpload + pin completed in ${elapsed}s\n<span class="pass">Pinned!</span>\n\nObject ID: ${objectId}`;
      } catch (e) {
        status.innerHTML += `\n<span class="fail">Error: ${e.message}</span>`;
      }
    });

    // -- Download File --
    document.getElementById('btn-download').addEventListener('click', async () => {
      const status = document.getElementById('dl-status');
      const progress = document.getElementById('dl-progress');
      const objectId = document.getElementById('dl-object-id').value.trim();
      const filename = document.getElementById('dl-filename').value.trim() || 'download';

      progress.style.display = 'none';
      progress.value = 0;

      if (!objectId) {
        status.innerHTML = '<span class="fail">Enter an Object ID</span>';
        return;
      }

      try {
        const sdk = await connectSdk(status);
        if (!sdk) return;

        status.innerHTML += '\nFetching object metadata...';

        const obj = await sdk.object(objectId);
        const size = obj.size();
        status.innerHTML = `Object found: ${formatSize(size)}`;

        progress.style.display = 'block';
        status.textContent = 'Downloading...';

        const downloadStart = performance.now();
        const data = await sdk.downloadWithProgress(obj, (current, total) => {
          progress.max = total;
          progress.value = current;
          status.textContent = `Downloading... ${current}/${total} slabs`;
        });
        const elapsed = ((performance.now() - downloadStart) / 1000).toFixed(1);

        // trigger browser save dialog
        const blob = new Blob([data]);
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);

        progress.value = progress.max;
        status.innerHTML = `File: ${filename}\nSize: ${formatSize(size)}\nDownloaded in ${elapsed}s\n<span class="pass">Saved to disk!</span>`;
      } catch (e) {
        status.innerHTML += `\n<span class="fail">Error: ${e.message}</span>`;
      }
    });

    // -- Share Object --
    document.getElementById('btn-share').addEventListener('click', async () => {
      const status = document.getElementById('share-status');
      const objectId = document.getElementById('share-object-id').value.trim();
      const duration = parseFloat(document.getElementById('share-duration').value);
      const unit = parseInt(document.getElementById('share-unit').value);

      if (!objectId) {
        status.innerHTML = '<span class="fail">Enter an Object ID</span>';
        return;
      }

      try {
        const sdk = await connectSdk(status);
        if (!sdk) return;

        status.textContent = 'Fetching object...';
        const obj = await sdk.object(objectId);

        const validUntilMs = Date.now() + (duration * unit);
        const shareUrl = sdk.shareObject(obj, validUntilMs);

        const expiresAt = new Date(validUntilMs).toLocaleString();
        status.innerHTML = `<span class="pass">Share link created!</span>\nExpires: ${expiresAt}\n\n<a href="${shareUrl}" target="_blank" rel="noopener" style="color:#60a5fa; word-break:break-all;">${shareUrl}</a>`;

        document.getElementById('share-url').value = shareUrl;
      } catch (e) {
        status.innerHTML += `\n<span class="fail">Error: ${e.message}</span>`;
      }
    });

    document.getElementById('btn-share-download').addEventListener('click', async () => {
      const status = document.getElementById('share-dl-status');
      const progress = document.getElementById('share-progress');
      const shareUrl = document.getElementById('share-url').value.trim();
      const filename = document.getElementById('share-filename').value.trim() || 'download';

      progress.style.display = 'none';
      progress.value = 0;

      if (!shareUrl) {
        status.innerHTML = '<span class="fail">Enter a share URL</span>';
        return;
      }

      try {
        const sdk = await connectSdk(status);
        if (!sdk) return;

        status.textContent = 'Fetching shared object...';
        const obj = await sdk.sharedObject(shareUrl);
        const size = obj.size();
        status.innerHTML = `Object found: ${formatSize(size)}`;

        progress.style.display = 'block';
        status.textContent = 'Downloading...';

        const downloadStart = performance.now();
        const data = await sdk.downloadWithProgress(obj, (current, total) => {
          progress.max = total;
          progress.value = current;
          status.textContent = `Downloading... ${current}/${total} slabs`;
        });
        const elapsed = ((performance.now() - downloadStart) / 1000).toFixed(1);

        const blob = new Blob([data]);
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);

        progress.value = progress.max;
        status.innerHTML = `File: ${filename}\nSize: ${formatSize(size)}\nDownloaded in ${elapsed}s\n<span class="pass">Saved to disk!</span>`;
      } catch (e) {
        status.innerHTML += `\n<span class="fail">Error: ${e.message}</span>`;
      }
    });

    // -- Stream HTML Page --
    document.getElementById('btn-stream-html').addEventListener('click', async () => {
      const status = document.getElementById('stream-status');
      const progress = document.getElementById('stream-progress');
      const iframe = document.getElementById('stream-iframe');
      const objectId = document.getElementById('stream-object-id').value.trim();
      const shareUrl = document.getElementById('stream-share-url').value.trim();

      progress.style.display = 'none';
      progress.value = 0;
      iframe.style.display = 'none';

      if (!objectId && !shareUrl) {
        status.innerHTML = '<span class="fail">Enter an Object ID or Share URL</span>';
        return;
      }

      try {
        const sdk = await connectSdk(status);
        if (!sdk) return;

        status.textContent = 'Fetching object metadata...';
        const obj = shareUrl
          ? await sdk.sharedObject(shareUrl)
          : await sdk.object(objectId);
        const size = obj.size();
        status.innerHTML = `Object found: ${formatSize(size)}`;

        progress.style.display = 'block';
        iframe.style.display = 'block';
        status.textContent = 'Streaming...';

        const chunks = [];
        const streamStart = performance.now();

        await sdk.downloadStreaming(obj,
          (chunk) => {
            // on_chunk: fired after each slab is decoded
            chunks.push(chunk);
            const blob = new Blob(chunks, { type: 'text/html' });
            iframe.src = URL.createObjectURL(blob);
          },
          (current, total) => {
            // on_progress
            progress.max = total;
            progress.value = current;
            status.textContent = `Streaming... ${current}/${total} slabs`;
          }
        );

        const elapsed = ((performance.now() - streamStart) / 1000).toFixed(1);
        progress.value = progress.max;
        status.innerHTML = `Size: ${formatSize(size)}\nStreamed in ${elapsed}s\n<span class="pass">HTML rendered below!</span>`;
      } catch (e) {
        status.innerHTML += `\n<span class="fail">Error: ${e.message}</span>`;
      }
    });

    // -- Sign / Verify --
    document.getElementById('btn-sign').addEventListener('click', () => {
      const out = document.getElementById('sign-output');
      const msg = document.getElementById('sign-message').value;
      if (!currentKey) {
        out.innerHTML = '<span class="fail">Create an AppKey first</span>';
        return;
      }
      const msgBytes = new TextEncoder().encode(msg);
      lastSignature = currentKey.sign(msgBytes);
      out.textContent = `Signature (${lastSignature.length} bytes):\n${hex(lastSignature)}`;
    });

    document.getElementById('btn-verify').addEventListener('click', () => {
      const out = document.getElementById('sign-output');
      if (!currentKey || !lastSignature) {
        out.innerHTML = '<span class="fail">Sign a message first</span>';
        return;
      }
      const msg = document.getElementById('sign-message').value;
      const msgBytes = new TextEncoder().encode(msg);
      try {
        const valid = currentKey.verifySignature(msgBytes, lastSignature);
        if (valid) {
          out.innerHTML += `\n\n<span class="pass">Signature is valid</span>`;
        } else {
          out.innerHTML += `\n\n<span class="fail">Signature is INVALID</span>`;
        }
      } catch (e) {
        out.innerHTML += `\n\n<span class="fail">Error: ${e.message}</span>`;
      }
    });
  </script>
</body>
</html>
